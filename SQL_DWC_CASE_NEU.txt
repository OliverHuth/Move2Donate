-- 1. CREATE HIERARCHY VIEW BASED ON HIERARCHY DATA FROM DWC TO BE CONSUMED BY THE ANONYMIZATION VIEW
DROP VIEW ANON_CITYHIERARCHY;
CREATE VIEW ANON_CITYHIERARCHY AS SELECT * FROM HIERARCHY(SOURCE (SELECT SUCC AS NODE_ID, PRED AS PARENT_ID FROM "M2D_ANONYMIZATION"."HIERARCHY_TO_HANA") SIBLING ORDER BY PARENT_ID, NODE_ID);
SELECT * FROM ANON_CITYHIERARCHY; 

-- 2. DEFINE THE ANONYMIZATION VIEW AS DESCRIBED IN THE BLOG
DROP VIEW ANON_RESULT_VIEW;
CREATE VIEW ANON_RESULT_VIEW (ID, AGGREGATEDTYPE, STARTLOCATION, STARTREGION, MONEYEARNED, DISTANCE) AS 
SELECT ID, AGGREGATEDTYPE, STARTLOCATION, STARTREGION, MONEYEARNED, DISTANCE
FROM "M2D_ANONYMIZATION"."EU_RESULT_VIEW"
WITH ANONYMIZATION ( ALGORITHM 'K-ANONYMITY' PARAMETERS '{"k": 10, "data_change_strategy":"static", "recoding":"multi_dimensional_relaxed"}' 
COLUMN ID PARAMETERS '{"is_sequence":true}' 
COLUMN STARTLOCATION PARAMETERS '{"is_quasi_identifier": true, "hierarchy":{"view": "ANON_CITYHIERARCHY"}}'  
COLUMN AGGREGATEDTYPE PARAMETERS '{"is_quasi_identifier":true, "hierarchy":{"embedded": [["Bike"], ["Run"]]}}');

-- 3. REFRESH THE ANONYMIZATION VIEW TO TRIGGER THE ACTUAL COMPUTATION OF ANONYMIZATION LEVELS
REFRESH VIEW ANON_RESULT_VIEW ANONYMIZATION;

-- 4. SELECT THE RESULTS OF THE ANONYMIZATION
SELECT * FROM ANON_RESULT_VIEW;

